{
  "hash": "993e660d60d69651e6d49c77da631e36",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Seminar 3: Difference-in-Differences\"\nformat:\n  html:\n    toc: true              # Include a table of contents in the HTML output\n    toc-depth: 2           # Set the depth of the table of contents\n    number-sections: true  # Number the sections in the HTML output\n    css: styles.css        # Optionally include custom CSS for styling\n    resources: \n      - \"seminar-3.pdf\"     # Make the PDF file available for download\n    #code-fold: true       # places code in dropdown\n  pdf:\n    #documentclass: article # LaTeX class used for the PDF document\n    toc: true              # Include a table of contents in the PDF output\n    number-sections: true  # Number the sections in the PDF output\n    keep-md: false          # Optionally keep the intermediate markdown file\n    output-file: \"seminar-3.pdf\" # Specify the PDF output file name\n    echo: true  # hides code\n---\n\n\n\n## Required R Packages\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(modelsummary)\nlibrary(psych)\nlibrary(plm)\nlibrary(broom)\n```\n:::\n\n\n\n## Learning Objectives\n\nIn this seminar you will:\n\n-   estimate dynamic difference-in-differences models and plot coefficients (with standard errors);\n-   evaluate the significance of cohort and unit fixed-effects;\n-   observe how estimators react to dynamic treatment effects, pre-emptive behaviour, and failure of parallel trends;\n-   and explore the impact of cohort heterogeneity and how to resolve it.\n\n## Motivation\n\nA quick examination of the applied literature will reveal the wide range of (linear regression) model specifications used to estimate the average treatment effect of the treated (ATT) of a (natural) experiment. Beyond differences in notation, this variation exists for number of important reasons:\n\n-   data: repeated cross-sections or panel data; more than two periods of observation;\n-   level of assignment: individual or group/cohort;\n-   timing of assignment: simultaneous or staggered; absorbing or alternating; presence of a never-treated control;\n-   assumptions regarding the treatment effect: static or dynamic; homogeneous or heterogeneous\n\nFor example, consider a setting where you have multiple periods of data both before and after treatment and the treatment was assigned at simultaneously at the unit level. The following model specification, with both unit and time FEs,\n\n$$\nY_{it} = \\alpha_i + \\delta_t + \\beta D_{i}\\cdot \\mathbf{1}\\{t\\geq t_0\\} + \\varepsilon_{it} \n$$ assumes that you have longitudinal data. You cannot estimate this model with repeated cross-sections, since each unit is observed once and the unit FEs will explain all the variation in $Y$. With repeated cross-sections, you would have to estimate,\n\n$$\nY_{it} = \\alpha + \\psi D_i + \\delta_t + \\beta D_{i}\\cdot \\mathbf{1}\\{t\\geq t_0\\} + \\varepsilon_{it} \n$$\n\nMoreover, by specifying a model that estimates a single post-treatment coefficient, you are implicitly making certain assumptions about the dynamics of the ATT. Afterall, if you believed that the treatment effect varied over time, why would you need estimate a dynamic specification; for example,\n\n$$\nY_{it} = \\alpha_i + \\delta_t + \\sum_{j\\neq t_0-1} \\beta_j D_{i}\\cdot \\mathbf{1}\\{t-t_0=j\\} + \\varepsilon_{it} \n$$\n\nThe dynamic specification would allow you to test for parallel trends or anticipatory behaviour.\n\nIn this seminar we will explore how to match the model specification to the experimental and empirical setting as well as the implications of getting this wrong.\n\n## Setup\n\nWe will simulate a panel (longitudinal) dataset in long-form. In long-form, each row-observation in the dataset represents a unit (\\$i\\$) in a single time period ($t$). There will be $t$ row-observations of each unit $i$ in a balanced panel. Panel data can also be arranged in wide-form, where each unit appears once and repeated observations are arranged as separate columns. To estimate a linear regression model, the data must be in long-form.[^1]\n\n[^1]: You can reshape data from wide to long (or vice versa) in STATA using the `reshape` command. In R this can be done using the `reshape2` package.\n\nStart by setting a seed. This ensures that all random number generators in this programme are replicable.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(27310)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nn <- 2000\nt <- 11\n```\n:::\n\n\n\n### Generate data\n\nGenerate an empty dataframe with 1000 observations.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- data.frame(matrix(ncol = 0, nrow = n))\n```\n:::\n\n\n\nCreate an ID variable equal to the row number.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf$id <- 1:nrow(df)\n```\n:::\n\n\n\nSplit ID's into different sized treatment groups.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf$group <- cut(df$id,\n                 breaks=c(0,500,1000,1400,1700,1900,2000),\n                 right=TRUE\n)\ndf$group <- as.integer(df$group)\n```\n:::\n\n\n\nThe last step converts the categorical variable into an integer.\n\nDuplicate the ID's for each period.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n  data <- df\n  i <- 1\n  while (i<t) {\n    data <- rbind(data,df)\n    i <- i+1\n  }\n```\n:::\n\n\n\nGenerate time variable.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- data %>%\n  group_by(id) %>%\n  mutate(time = 1:t) %>%\n  arrange(id,time)\n```\n:::\n\n\n\nWe are going to generate the underlying $Y(0)$ variable based on a two-way FEs structure:\n\n$$\n  Y_{it}(0) = \\alpha_i + \\delta_t + \\varepsilon_{it}\n$$ with,\n\n-   $\\alpha = 1+0.05\\cdot (c-1)$ where $c$ is a individual's cohort. This ensures level differences across treatment groups.\n\n-   $\\delta_t = 1 +0.1\\cdot (t-1)$, which will generate a linear time trend.\n\n-   $\\varepsilon_{it}\\sim_{iid} \\; N(0,\\sigma)$\n\nSet values\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsigma <- 0.55\ndata <- data %>%\n  mutate(\n    alpha = 1 + 0.05*group,\n    delta = 1 + 0.1*time,\n    epsilon = rnorm(n(),0,sigma),\n    y0 = alpha + delta + epsilon\n    )\n```\n:::\n\n\n\nThe data we have generated has parallel trends across groups. We demonstrate this fact by plotting the average of the outcome for each group, over time.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Compute group averages\ndata_avg <- data %>%\n  group_by(time, group) %>%\n  summarize(avg_y0 = mean(y0), .groups = 'drop')\n\n# Plot the time trend of group averages\nggplot(data_avg, aes(x = time, y = avg_y0, color = group, group = group)) +\n  geom_line() +                      # Add lines for each group\n  geom_point() +                     # Add points to show averages\n  labs(\n    title = \"Time trend of Y(0) by group\",\n    x = \"Time\",\n    y = \"E[Y(0)]\",\n    color = \"Group\"\n  ) \n```\n\n::: {.cell-output-display}\n![](seminar-3_files/figure-pdf/unnamed-chunk-10-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n## Case 1: Dynamic Difference-in-Difference\n\nWe begin by examining the instance where half of the sample are treated in period 6 (groups 1 and 2), while the remaining sample is never treated.\n\n1.  Let's create the following three dummy variables:\n\n-   $D_i = \\mathbf{1}\\{c\\leq 2\\}$: indicator for treated group (time-invariant)\n-   $T_t = \\mathbf{1}\\{t>=6\\}$: indicator for post treatment periods\n-   $D_i\\cdot T_t$: indicator for treated group, after treatment (time-varying)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata1 <- data\ndata1 <- data1 %>%\n  mutate(trtgrp = (group<=2)*1,\n         post = (time>=6)*1,\n         trtpost = trtgrp*post, \n         trttime = as.factor(trtgrp*time),\n         trttimepost = as.factor(trtgrp*time*post))\n```\n:::\n\n\n\nFirst, we will generate data based on a static, homogeneous treatment effect: $\\tau = 0.2$.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata1 <- data1 %>%\n  mutate(yobs = y0 + trtpost*0.1)\n```\n:::\n\n\n\nGiven this DGP, there are a few specifications we can estimate.\n\n1.  Simple (i.e. 2-group-2-period) specification\n$$\n    Y_{it} = \\alpha + \\psi D_i + \\delta T_t + \\beta D_{i}\\cdot T_t + \\varepsilon_{it}\n$$\n\n2.  Static specification with time FEs, but no unit FEs\n$$\n    Y_{it} = \\alpha + \\psi D_i + \\delta_t + \\beta D_{i}\\cdot T_t + \\varepsilon_{it}\n$$\n\n3.  Static specification with two-way FEs\n$$\n    Y_{it} = \\alpha_i + \\delta_t + \\beta D_{i}\\cdot T_t + \\varepsilon_{it}\n$$\n4.  Semi-dynamic specification (with group or unit FEs)\n$$\n    Y_{it} = \\alpha_i + \\delta_t + \\sum_{j>5} \\beta_j D_{i}\\cdot \\mathbf{1}\\{t-6=j\\} + \\varepsilon_{it}\n$$\n\n5.  Dynamic specification (with group or unit FEs)\n$$\n    Y_{it} = \\alpha_i + \\delta_t + \\sum_{j\\neq 5} \\beta_j D_{i}\\cdot \\mathbf{1}\\{t-6=j\\} + \\varepsilon_{it}\n$$\n\n\n::: {.cell}\n\n```{.r .cell-code}\nreg1 <- lm(yobs ~ trtpost + trtgrp + post, data=data1)\n\n\nreg2 <- plm(yobs ~ trtpost + trtgrp, data=data1, index=c(\"id\",\"time\"), model = \"within\", effect = \"time\")\n\n# Alternative programming (computes different R2):\n#reg2 <- lm(yobs ~ trtpost + trtgrp + as.factor(time), data=data1)\n\nreg3 <- plm(yobs ~ trtpost, data=data1, index=c(\"id\",\"time\"), model = \"within\", effect = \"twoways\")\n\nmodelsummary(list(\"(1)\"=reg1,\"(2)\"=reg2, \"(3)\"=reg3), stars=c('*'=.1, '**'=.05,'***'=.01), coef_omit=-(2), gof_map = c(\"nobs\", \"r.squared\", \"rmse\"), title = \"Static specifications 1-3\")\n```\n\n::: {.cell-output-display}\n\\begin{table}\n\\centering\n\\begin{talltblr}[         %% tabularray outer open\ncaption={Static specifications 1-3},\nentry=none,label=none,\nnote{}={* p < 0.1, ** p < 0.05, *** p < 0.01},\n]                     %% tabularray outer close\n{                     %% tabularray inner open\ncolspec={Q[]Q[]Q[]Q[]},\ncolumn{1}={halign=l,},\ncolumn{2}={halign=c,},\ncolumn{3}={halign=c,},\ncolumn{4}={halign=c,},\nhline{4}={1,2,3,4}{solid, 0.05em, black},\n}                     %% tabularray inner close\n\\toprule\n& (1) & (2) & (3) \\\\ \\midrule %% TinyTableHeader\ntrtpost  & \\num{0.106}*** & \\num{0.106}*** & \\num{0.106}*** \\\\\n& (\\num{0.016})  & (\\num{0.015})  & (\\num{0.015})  \\\\\nNum.Obs. & \\num{22000}    & \\num{22000}    & \\num{22000}    \\\\\nR2       & \\num{0.221}    & \\num{0.006}    & \\num{0.003}    \\\\\nRMSE     & \\num{0.57}     & \\num{0.55}     & \\num{0.52}     \\\\\n\\bottomrule\n\\end{talltblr}\n\\end{table}\n:::\n:::\n\n\n\n\nThe dynamic specifications, \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata1 <- data1 %>%\n  mutate(btrtgrp = as.factor(trtgrp),\n         btrttime = as.factor(trttime),\n         btrttime = relevel(trttime,\"5\"),\n         btrttimepost = as.factor(trttimepost)\n  )\n\nreg4a <- plm(yobs ~ btrtgrp + btrttimepost, data=data1, index=c(\"id\",\"time\"), model = \"within\", effect = \"time\")\n\nreg4b <- plm(yobs ~ btrttimepost, data=data1, index=c(\"id\",\"time\"), model = \"within\", effect = \"twoways\")\n\nmodelsummary(list(\"(4a)\"=reg4a,\"(4b)\"=reg4b), stars=c('*'=.1, '**'=.05,'***'=.01), coef_omit=(\"btrtgrp\"), gof_map = c(\"nobs\", \"r.squared\", \"rmse\"), title = \"Semi-dynamic specification 4\")\n```\n\n::: {.cell-output-display}\n\\begin{table}\n\\centering\n\\begin{talltblr}[         %% tabularray outer open\ncaption={Semi-dynamic specification 4},\nentry=none,label=none,\nnote{}={* p < 0.1, ** p < 0.05, *** p < 0.01},\n]                     %% tabularray outer close\n{                     %% tabularray inner open\ncolspec={Q[]Q[]Q[]},\ncolumn{1}={halign=l,},\ncolumn{2}={halign=c,},\ncolumn{3}={halign=c,},\nhline{14}={1,2,3}{solid, 0.05em, black},\n}                     %% tabularray inner close\n\\toprule\n& (4a) & (4b) \\\\ \\midrule %% TinyTableHeader\nbtrttimepost6  & \\num{0.101}*** & \\num{0.101}*** \\\\\n& (\\num{0.027})  & (\\num{0.027})  \\\\\nbtrttimepost7  & \\num{0.132}*** & \\num{0.132}*** \\\\\n& (\\num{0.027})  & (\\num{0.027})  \\\\\nbtrttimepost8  & \\num{0.121}*** & \\num{0.121}*** \\\\\n& (\\num{0.027})  & (\\num{0.027})  \\\\\nbtrttimepost9  & \\num{0.094}*** & \\num{0.094}*** \\\\\n& (\\num{0.027})  & (\\num{0.027})  \\\\\nbtrttimepost10 & \\num{0.104}*** & \\num{0.104}*** \\\\\n& (\\num{0.027})  & (\\num{0.027})  \\\\\nbtrttimepost11 & \\num{0.087}*** & \\num{0.087}*** \\\\\n& (\\num{0.027})  & (\\num{0.027})  \\\\\nNum.Obs.       & \\num{22000}    & \\num{22000}    \\\\\nR2             & \\num{0.006}    & \\num{0.003}    \\\\\nRMSE           & \\num{0.55}     & \\num{0.52}     \\\\\n\\bottomrule\n\\end{talltblr}\n\\end{table}\n:::\n\n```{.r .cell-code}\nreg5a <- plm(yobs ~ btrtgrp + btrttime, data=data1, index=c(\"id\",\"time\"), model = \"within\", effect = \"time\")\n\nreg5b <- plm(yobs ~ btrttime, data=data1, index=c(\"id\",\"time\"), model = \"within\", effect = \"twoways\")\n\nmodelsummary(list(\"(5a)\"=reg5a, \"(5b)\"=reg5b), stars=c('*'=.1, '**'=.05,'***'=.01), coef_omit=(\"btrtgrp\"), gof_map = c(\"nobs\", \"r.squared\", \"rmse\"), title = \"Dynamic specification 5\")\n```\n\n::: {.cell-output-display}\n\\begin{table}\n\\centering\n\\begin{talltblr}[         %% tabularray outer open\ncaption={Dynamic specification 5},\nentry=none,label=none,\nnote{}={* p < 0.1, ** p < 0.05, *** p < 0.01},\n]                     %% tabularray outer close\n{                     %% tabularray inner open\ncolspec={Q[]Q[]Q[]},\ncolumn{1}={halign=l,},\ncolumn{2}={halign=c,},\ncolumn{3}={halign=c,},\nhline{22}={1,2,3}{solid, 0.05em, black},\n}                     %% tabularray inner close\n\\toprule\n& (5a) & (5b) \\\\ \\midrule %% TinyTableHeader\nbtrttime1  & \\num{0.022}    & \\num{0.022}    \\\\\n& (\\num{0.035})  & (\\num{0.035})  \\\\\nbtrttime2  & \\num{0.022}    & \\num{0.022}    \\\\\n& (\\num{0.035})  & (\\num{0.035})  \\\\\nbtrttime3  & \\num{0.009}    & \\num{0.009}    \\\\\n& (\\num{0.035})  & (\\num{0.035})  \\\\\nbtrttime4  & \\num{0.002}    & \\num{0.002}    \\\\\n& (\\num{0.035})  & (\\num{0.035})  \\\\\nbtrttime6  & \\num{0.112}*** & \\num{0.112}*** \\\\\n& (\\num{0.035})  & (\\num{0.035})  \\\\\nbtrttime7  & \\num{0.143}*** & \\num{0.143}*** \\\\\n& (\\num{0.035})  & (\\num{0.035})  \\\\\nbtrttime8  & \\num{0.132}*** & \\num{0.132}*** \\\\\n& (\\num{0.035})  & (\\num{0.035})  \\\\\nbtrttime9  & \\num{0.105}*** & \\num{0.105}*** \\\\\n& (\\num{0.035})  & (\\num{0.035})  \\\\\nbtrttime10 & \\num{0.115}*** & \\num{0.115}*** \\\\\n& (\\num{0.035})  & (\\num{0.035})  \\\\\nbtrttime11 & \\num{0.098}*** & \\num{0.098}*** \\\\\n& (\\num{0.035})  & (\\num{0.035})  \\\\\nNum.Obs.   & \\num{22000}    & \\num{22000}    \\\\\nR2         & \\num{0.006}    & \\num{0.003}    \\\\\nRMSE       & \\num{0.55}     & \\num{0.52}     \\\\\n\\bottomrule\n\\end{talltblr}\n\\end{table}\n:::\n:::\n\n\n\nHowever, with dynamic models it makes more sense to plot the coefficients in a graph. Let us quick create a function that will graph the plots. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\neventplot <- function(model,start,end,treat) {\n  coef_model <- tidy(model, conf.int = TRUE)\n  # extract event-times from coefficient labels\n  coef_model$time <- as.integer(substr(coef_model$term,9,10))\n  #append row with estimate=0 for base period\n  coef_0 <- data.frame(term = NA, estimate = 0, std.error = NA, statistic = NA, p.value = NA, conf.low = NA, conf.high = NA, time = -1)\n  coef_model <- rbind(coef_model,coef_0)\n  coef_model <- arrange(coef_model,time)\n  # plot graph\n  graph <- ggplot(coef_model, aes(x = time, y = estimate)) +\n    geom_point() +            # Plot the point estimates\n    geom_line() +             # Connect point estimates with line\n    geom_line(y=0) +          # Horizontal line\n    geom_vline(xintercept = treat-0.5, color = \"red\", linetype = \"dashed\", size = 1) +        \n    geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0.2) +  # Add error bars for the confidence intervals\n    labs(\n      title = \"Dynamic coefficients from specification 5\",\n      x = \"Event-time\",\n      y = \"Estimate\"\n    ) +\n    scale_x_continuous(breaks = -start:end, labels = -start:end)\n  return(graph)\n}\n```\n:::\n\n\nLet's try this specification 5, with unit FEs. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\neventplot(reg5b,1,11,6)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.\ni Please use `linewidth` instead.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![test](seminar-3_files/figure-pdf/fig-test-1.pdf){#fig-test fig-pos='H'}\n:::\n:::\n\n\n\n## Case 2: Staggered Intervention\n\nNext, we will examine the staggered intervention case. Group 1 will remain untreated, while groups 2-6 are treated at separated times. We will use the groups as separate cohorts with treatment times given by, \n\n$$\nS_c \\in \\{\\infty,4,5,6,7,8\\}\n$$\n\nWe begin by assigning each of the groups in the simulated dataset a cohort value, as above. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata2 <- data %>%\n  mutate(cohort = ifelse(group>1,group+2,NA),\n         etime = time-cohort,\n         )\ntable(data2$etime, data2$cohort, useNA = \"ifany\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      \n          4    5    6    7    8 <NA>\n  -7      0    0    0    0  100    0\n  -6      0    0    0  200  100    0\n  -5      0    0  300  200  100    0\n  -4      0  400  300  200  100    0\n  -3    500  400  300  200  100    0\n  -2    500  400  300  200  100    0\n  -1    500  400  300  200  100    0\n  0     500  400  300  200  100    0\n  1     500  400  300  200  100    0\n  2     500  400  300  200  100    0\n  3     500  400  300  200  100    0\n  4     500  400  300  200    0    0\n  5     500  400  300    0    0    0\n  6     500  400    0    0    0    0\n  7     500    0    0    0    0    0\n  <NA>    0    0    0    0    0 5500\n```\n\n\n:::\n:::\n\n\nNote, these two variables have missing values corresponding to the never-treated group. From a programming perspective we do not want any variables in the estimator to have missing values. For this reason, we will create a set of event-time variables that will be used in the estimator that have no missing values. We will do so by replacing NT treated value of event-time to the chosen based period.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbase <- -1\n\ndata2$trtgrp <- data2$cohort\ndata2$trtgrp[is.na(data2$trtgrp)] <- base\n# cross-tabulate treatment-group and cohort\ntable(data2$trtgrp, data2$cohort, useNA = \"ifany\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    \n        4    5    6    7    8 <NA>\n  -1    0    0    0    0    0 5500\n  4  5500    0    0    0    0    0\n  5     0 4400    0    0    0    0\n  6     0    0 3300    0    0    0\n  7     0    0    0 2200    0    0\n  8     0    0    0    0 1100    0\n```\n\n\n:::\n\n```{.r .cell-code}\ndata2$trttime <- data2$etime\ndata2$trttime[is.na(data2$trttime)] <- base \n# cross-tabulate event-time and cohort\ntable(data2$trttime, data2$cohort, useNA = \"ifany\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    \n        4    5    6    7    8 <NA>\n  -7    0    0    0    0  100    0\n  -6    0    0    0  200  100    0\n  -5    0    0  300  200  100    0\n  -4    0  400  300  200  100    0\n  -3  500  400  300  200  100    0\n  -2  500  400  300  200  100    0\n  -1  500  400  300  200  100 5500\n  0   500  400  300  200  100    0\n  1   500  400  300  200  100    0\n  2   500  400  300  200  100    0\n  3   500  400  300  200  100    0\n  4   500  400  300  200    0    0\n  5   500  400  300    0    0    0\n  6   500  400    0    0    0    0\n  7   500    0    0    0    0    0\n```\n\n\n:::\n\n```{.r .cell-code}\ndata2$trttimepost = data2$trttime\ndata2$trttimepost[(data2$trttimepost<0)] <- base\n# cross-tabulate event-time and post-treatment-event-times\ntable(data2$trttimepost, data2$etime, useNA = \"ifany\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    \n       -7   -6   -5   -4   -3   -2   -1    0    1    2    3    4    5    6    7\n  -1  100  300  600 1000 1500 1500 1500    0    0    0    0    0    0    0    0\n  0     0    0    0    0    0    0    0 1500    0    0    0    0    0    0    0\n  1     0    0    0    0    0    0    0    0 1500    0    0    0    0    0    0\n  2     0    0    0    0    0    0    0    0    0 1500    0    0    0    0    0\n  3     0    0    0    0    0    0    0    0    0    0 1500    0    0    0    0\n  4     0    0    0    0    0    0    0    0    0    0    0 1400    0    0    0\n  5     0    0    0    0    0    0    0    0    0    0    0    0 1200    0    0\n  6     0    0    0    0    0    0    0    0    0    0    0    0    0  900    0\n  7     0    0    0    0    0    0    0    0    0    0    0    0    0    0  500\n    \n     <NA>\n  -1 5500\n  0     0\n  1     0\n  2     0\n  3     0\n  4     0\n  5     0\n  6     0\n  7     0\n```\n\n\n:::\n:::\n\n\n\nUsing the same underlying two-way FEs DGP, we generate a new dataset that includes a dynamic treatment effect. \n\n$$\n  Y^{obs}_{it} = \\alpha_i + \\delta_t + \\sum_{s}\\tau(s)\\mathbf{1}\\{t-S_i=s\\} + \\varepsilon_{it}\n$$ \nWe will allow the treatment effect to increase with (event) time, but remain homogeneous across units/cohorts: $\\tau(s) = 0.1 + 0.025\\cdot s$ for $s\\geq 0$; where $s$ is event-time. Note, we have ruled out anticipation.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata2 <- data2 %>%\n  mutate(yobs1 = y0 + (0.1 + 0.025*trttime)*(trttime>=0)\n         )\n```\n:::\n\n\n\nThe dynamic specifications, \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# create factor variables to use in plm() and set base category\ndata2 <- data2 %>%\n  mutate(btrtgrp = as.factor(trtgrp),\n         btrtgrp = relevel(btrtgrp,ref = \"-1\"),\n         btrttime = relevel(as.factor(trttime), \"-1\"),\n         btrttimepost = relevel(as.factor(trttimepost),\"-1\")\n  )\n\nreg6a <- plm(yobs1 ~ btrtgrp + btrttimepost, data=data2, index=c(\"id\",\"time\"), model = \"within\", effect = \"time\")\n\nreg6b <- plm(yobs1 ~ btrttimepost, data=data2, index=c(\"id\",\"time\"), model = \"within\", effect = \"twoways\")\n\nmodelsummary(list(\"6(a)\"=reg6a,\"6(b)\"=reg6b), stars=c('*'=.1, '**'=.05,'***'=.01), gof_map = c(\"nobs\", \"r.squared\", \"rmse\"), title = \"Semi-dynamic specifications\")\n```\n\n::: {.cell-output-display}\n\\begin{table}\n\\centering\n\\begin{talltblr}[         %% tabularray outer open\ncaption={Semi-dynamic specifications},\nentry=none,label=none,\nnote{}={* p < 0.1, ** p < 0.05, *** p < 0.01},\n]                     %% tabularray outer close\n{                     %% tabularray inner open\ncolspec={Q[]Q[]Q[]},\ncolumn{1}={halign=l,},\ncolumn{2}={halign=c,},\ncolumn{3}={halign=c,},\nhline{28}={1,2,3}{solid, 0.05em, black},\n}                     %% tabularray inner close\n\\toprule\n& 6(a) & 6(b) \\\\ \\midrule %% TinyTableHeader\nbtrtgrp4      & \\num{0.065}*** &                 \\\\\n& (\\num{0.016})  &                 \\\\\nbtrtgrp5      & \\num{0.111}*** &                 \\\\\n& (\\num{0.015})  &                 \\\\\nbtrtgrp6      & \\num{0.172}*** &                 \\\\\n& (\\num{0.015})  &                 \\\\\nbtrtgrp7      & \\num{0.192}*** &                 \\\\\n& (\\num{0.015})  &                 \\\\\nbtrtgrp8      & \\num{0.230}*** &                 \\\\\n& (\\num{0.019})  &                 \\\\\nbtrttimepost0 & \\num{0.083}*** & \\num{0.083}*** \\\\\n& (\\num{0.018})  & (\\num{0.018})  \\\\\nbtrttimepost1 & \\num{0.105}*** & \\num{0.105}*** \\\\\n& (\\num{0.019})  & (\\num{0.019})  \\\\\nbtrttimepost2 & \\num{0.120}*** & \\num{0.120}*** \\\\\n& (\\num{0.020})  & (\\num{0.020})  \\\\\nbtrttimepost3 & \\num{0.151}*** & \\num{0.151}*** \\\\\n& (\\num{0.021})  & (\\num{0.021})  \\\\\nbtrttimepost4 & \\num{0.212}*** & \\num{0.212}*** \\\\\n& (\\num{0.022})  & (\\num{0.022})  \\\\\nbtrttimepost5 & \\num{0.197}*** & \\num{0.197}*** \\\\\n& (\\num{0.025})  & (\\num{0.025})  \\\\\nbtrttimepost6 & \\num{0.243}*** & \\num{0.243}*** \\\\\n& (\\num{0.028})  & (\\num{0.028})  \\\\\nbtrttimepost7 & \\num{0.262}*** & \\num{0.262}*** \\\\\n& (\\num{0.036})  & (\\num{0.036})  \\\\\nNum.Obs.      & \\num{22000}    & \\num{22000}    \\\\\nR2            & \\num{0.037}    & \\num{0.006}    \\\\\nRMSE          & \\num{0.55}     & \\num{0.52}     \\\\\n\\bottomrule\n\\end{talltblr}\n\\end{table}\n:::\n\n```{.r .cell-code}\nreg7a <- plm(yobs1 ~ btrtgrp + btrttime, data=data2, index=c(\"id\",\"time\"), model = \"within\", effect = \"time\")\n\nreg7b <- plm(yobs1 ~ btrttime, data=data2, index=c(\"id\",\"time\"), model = \"within\", effect = \"twoways\")\n\nmodelsummary(list(\"7(a)\"=reg7a, \"7(b)\"=reg7b), stars=c('*'=.1, '**'=.05,'***'=.01), gof_map = c(\"nobs\", \"r.squared\", \"rmse\"), title = \"Dynamic specifications\")\n```\n\n::: {.cell-output-display}\n\\begin{table}\n\\centering\n\\begin{talltblr}[         %% tabularray outer open\ncaption={Dynamic specifications},\nentry=none,label=none,\nnote{}={* p < 0.1, ** p < 0.05, *** p < 0.01},\n]                     %% tabularray outer close\n{                     %% tabularray inner open\ncolspec={Q[]Q[]Q[]},\ncolumn{1}={halign=l,},\ncolumn{2}={halign=c,},\ncolumn{3}={halign=c,},\nhline{40}={1,2,3}{solid, 0.05em, black},\n}                     %% tabularray inner close\n\\toprule\n& 7(a) & 7(b) \\\\ \\midrule %% TinyTableHeader\nbtrtgrp4   & \\num{0.051}*** &                 \\\\\n& (\\num{0.019})  &                 \\\\\nbtrtgrp5   & \\num{0.098}*** &                 \\\\\n& (\\num{0.019})  &                 \\\\\nbtrtgrp6   & \\num{0.157}*** &                 \\\\\n& (\\num{0.019})  &                 \\\\\nbtrtgrp7   & \\num{0.177}*** &                 \\\\\n& (\\num{0.021})  &                 \\\\\nbtrtgrp8   & \\num{0.223}*** &                 \\\\\n& (\\num{0.025})  &                 \\\\\nbtrttime-3 & \\num{0.013}    & \\num{0.013}    \\\\\n& (\\num{0.022})  & (\\num{0.022})  \\\\\nbtrttime-2 & \\num{0.030}    & \\num{0.030}    \\\\\n& (\\num{0.021})  & (\\num{0.021})  \\\\\nbtrttime0  & \\num{0.096}*** & \\num{0.096}*** \\\\\n& (\\num{0.021})  & (\\num{0.021})  \\\\\nbtrttime1  & \\num{0.118}*** & \\num{0.118}*** \\\\\n& (\\num{0.022})  & (\\num{0.022})  \\\\\nbtrttime2  & \\num{0.133}*** & \\num{0.133}*** \\\\\n& (\\num{0.023})  & (\\num{0.023})  \\\\\nbtrttime3  & \\num{0.163}*** & \\num{0.163}*** \\\\\n& (\\num{0.023})  & (\\num{0.023})  \\\\\nbtrttime4  & \\num{0.226}*** & \\num{0.226}*** \\\\\n& (\\num{0.025})  & (\\num{0.025})  \\\\\nbtrttime5  & \\num{0.210}*** & \\num{0.210}*** \\\\\n& (\\num{0.027})  & (\\num{0.027})  \\\\\nbtrttime6  & \\num{0.256}*** & \\num{0.256}*** \\\\\n& (\\num{0.030})  & (\\num{0.030})  \\\\\nbtrttime7  & \\num{0.276}*** & \\num{0.276}*** \\\\\n& (\\num{0.037})  & (\\num{0.037})  \\\\\nbtrttime-4 & \\num{0.005}    & \\num{0.005}    \\\\\n& (\\num{0.025})  & (\\num{0.025})  \\\\\nbtrttime-5 & \\num{0.041}    & \\num{0.041}    \\\\\n& (\\num{0.031})  & (\\num{0.031})  \\\\\nbtrttime-6 & \\num{0.010}    & \\num{0.010}    \\\\\n& (\\num{0.040})  & (\\num{0.040})  \\\\\nbtrttime-7 & \\num{-0.071}   & \\num{-0.071}   \\\\\n& (\\num{0.063})  & (\\num{0.063})  \\\\\nNum.Obs.   & \\num{22000}    & \\num{22000}    \\\\\nR2         & \\num{0.037}    & \\num{0.006}    \\\\\nRMSE       & \\num{0.55}     & \\num{0.52}     \\\\\n\\bottomrule\n\\end{talltblr}\n\\end{table}\n:::\n:::\n\n\n\nWe can use the same function to plot the last model.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\neventplot(reg7b,-7,7,0)\n```\n\n::: {.cell-output-display}\n![](seminar-3_files/figure-pdf/unnamed-chunk-21-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n## Case 3: Failure of parallel trends and anticipation\n\nLet's generate an alternative observed outcome where the units respond to the treatment two periods before treatment is assigned. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata2 <- data2 %>%\n  mutate(yobs2 = y0 + (0.1 + 0.025*(trttime+2))*(trttime+2>=0)*(trtgrp>0)\n         )\n# the last condition ensures that never-treated are excluded\n\nreg8 <- plm(yobs2 ~ btrttime, data=data2, index=c(\"id\",\"time\"), model = \"within\", effect = \"twoways\")\n\neventplot(reg8,-7,7,0)\n```\n\n::: {.cell-output-display}\n![](seminar-3_files/figure-pdf/unnamed-chunk-22-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\nAnd a second instance where parallel trends do not hold. Recall, the trend component of $Y(0)$ was given by $\\delta_t = 1 +0.1\\cdot (t-1)$. Let's remove the trend for the never-treated group. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata2 <- data2 %>%\n  mutate(yobs3 = y0 -0.1*(time-1)*(trtgrp==-1) + (0.1 + 0.025*trttime)*(trttime>=0)\n         )\n# the last condition ensures that never-treated are excluded\n\nreg9 <- plm(yobs3 ~ btrttime, data=data2, index=c(\"id\",\"time\"), model = \"within\", effect = \"twoways\")\n\neventplot(reg9,-7,7,0)\n```\n\n::: {.cell-output-display}\n![](seminar-3_files/figure-pdf/unnamed-chunk-23-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n## Case 4: Cohort-specific ATT\n\n**INCOMPLETE**\n",
    "supporting": [
      "seminar-3_files\\figure-pdf"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "\\usepackage{float}\n\\usepackage{tabularray}\n\\usepackage[normalem]{ulem}\n\\usepackage{graphicx}\n\\UseTblrLibrary{booktabs}\n\\UseTblrLibrary{siunitx}\n\\NewTableCommand{\\tinytableDefineColor}[3]{\\definecolor{#1}{#2}{#3}}\n\\newcommand{\\tinytableTabularrayUnderline}[1]{\\underline{#1}}\n\\newcommand{\\tinytableTabularrayStrikeout}[1]{\\sout{#1}}\n"
      ]
    },
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}